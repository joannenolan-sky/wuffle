<script>
  import {
    autoresize,
    isOpenOrMerged,
    isPull,
    hasModifier,
    noDuplicates
  } from './util';

  import Tag from './components/Tag.svelte';
  import Status from './components/Status.svelte';
  import PullRequestIcon from './components/PullRequestIcon.svelte';
  import EpicIcon from './components/EpicIcon.svelte';

  import CardLink from './CardLink.svelte';

  const linkOrder = {
    'PARENT_OF': 0,
    'CHILD_OF': 1,
    'REQUIRED_BY': 2,
    'DEPENDS_ON': 3,
    'LINKED_TO': 4
  };

  export let item;

  export let className = '';

  export let onSelect;

  let showChildren = false;

  $: id = item.id;
  $: number = item.number;
  $: title = item.title;
  $: repository = item.repository;
  $: milestone = item.milestone;
  $: labels = item.labels.filter(l => !l.column_label);
  $: pull_request = item.pull_request;

  $: links = item.links || [];
// console.log( item.links );
  $: embeddedLinks = links.filter(
    (link) => !isPull(link.target) && link.type !== 'LINKED_BY'
  ).sort(
    (a, b) => {
      return linkOrder[a.type] - linkOrder[b.type];
    }
  );

  $: shownLinks = embeddedLinks.filter(link => showChildren || link.type !== 'PARENT_OF');

  $: children = embeddedLinks.filter(l => l.type === 'PARENT_OF');
  $: completedChildren = children.filter(l => l.target.state === 'closed');

  $: prLinks = links.filter(
    link => isPull(link.target) && isOpenOrMerged(link.target)
  ).filter(noDuplicates(link => link.target.id));

  $: status = item.statuses || [];

  $: assignees = item.assignees || [];

  $: requested_reviewers = item.requested_reviewers || [];

  $: repositoryName = `${repository.owner.login}/${repository.name}`;

  $: cardUrl = `https://github.com/${ repositoryName }/issues/${ number }`;

  function handleSelection(qualifier, value) {

    return function(event) {

      if (hasModifier(event)) {
        return;
      }

      event.preventDefault();

      onSelect(qualifier, value);
    };
  }
</script>

<style lang="scss">
  @import "variables";

  @import "./Card";

  :global(.tag).label,
  :global(.tag).tag.milestone {
    margin-right: 4px;
    margin-bottom: 4px;
  }

  :global(.tag).milestone {
    color: $gray-800 !important;
    border: solid 1px $gray-600;
  }

  .board-card-links.attached {
    background: #F9F9F9;
    border-radius: 0 0 4px 4px;
    box-shadow: inset 0 3px 5px -2px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.1);
    margin-top: -6px;
    position: relative;
    padding: 7px 8px 4px 8px;

    :global(.card-link):first-child {
      border-top: none;
    }
  }

  .progress {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin-bottom: 7px;

    cursor: pointer;

    &:hover {
      svg {
        color: $gray-600;
      }
    }

    svg {
      color: #CCC;
      transition: color .3s;
    }

    .bar {
      border-radius: 3px;
      height: 5px;
      width: 80px;
      background: #EEE;
      margin: auto 6px;

      .indicator {
        border-radius: 3px;
        background: $gray-600;
        height: 100%;
      }
    }

    .text {
      margin-left: 6px;
      font-size: 0.9rem;
      color: $gray-600;
    }
  }

</style>

<div class="board-card-container { className }">
  <div class="board-card">
    <div class="header">
      {#if children.length}
        <EpicIcon item={ item } linkType="PARENT_OF"  onClick={ onSelect && handleSelection('ref', item.key) }/>
      {/if}
      {#if pull_request}
        <PullRequestIcon item={ item } />
      {/if}

      <a href={ cardUrl }
         target="_blank"
         rel="noopener noreferrer"
         class="issue-number"
         title="{ repositoryName }#{ number }"
      >{ number }</a>

      <span class="repository" title={ repositoryName }>{ repositoryName }</span>

      <span class="collaborator-links">
        {#each assignees as assignee}
          <span class="assignee" title="{ assignee.login } assigned">
            <img src="{ assignee.avatar_url }&s=40" alt="{ assignee.login } avatar" />
          </span>
        {/each}

        {#each requested_reviewers as reviewer}
          <span class="assignee reviewer" title="{ reviewer.login } requested for review">
            <img src="{ reviewer.avatar_url }&s=40" alt="{ reviewer.login } avatar" />
          </span>
        {/each}
      </span>
    </div>
    <div class="title">
      <textarea use:autoresize>{ title }</textarea>
    </div>
    {#if children.length}
      <div
        class="progress"
        on:click={ () => showChildren = !showChildren }
        title="Click toggle child tasks ({ completedChildren.length } of { children.length } completed)">
        <svg class="icon issue closed" width="1rem" height="1rem" viewBox="0 0 16 16" version="1.1" aria-hidden="true" fill="currentColor">
          <path fill-rule="evenodd" d="M7 10h2v2H7v-2zm2-6H7v5h2V4zm1.5 1.5l-1 1L12 9l4-4.5-1-1L12 7l-1.5-1.5zM8 13.7A5.71 5.71 0 0 1 2.3 8c0-3.14 2.56-5.7 5.7-5.7 1.83 0 3.45.88 4.5 2.2l.92-.92A6.947 6.947 0 0 0 8 1C4.14 1 1 4.14 1 8s3.14 7 7 7 7-3.14 7-7l-1.52 1.52c-.66 2.41-2.86 4.19-5.48 4.19v-.01z"></path>
        </svg>
        <div class="text">
          { completedChildren.length } of { children.length }
        </div>
        <div class="bar">
          <div class="indicator" style="width: { completedChildren.length / children.length * 100 }%"></div>
        </div>
      </div>
    {/if}
    <div class="footer">
      {#if milestone}
        <Tag
          class="tag milestone"
          name={ milestone.title }
          onClick={ onSelect && handleSelection('milestone', milestone.title) }
        />
      {/if}

      {#each labels as { name, color }}
        <Tag
          class="tag label"
          color="#{ color }"
          name={ name }
          onClick={ onSelect && handleSelection('label', name) }
        />
      {/each}

      <div class="links">
        <a href={ cardUrl } title="View on GitHub" target="_blank" rel="noopener noreferrer">
          <i aria-label="icon: github" class="anticon anticon-github">
            <svg viewBox="64 64 896 896" class="" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false">
              <path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path>
            </svg>
          </i>
        </a>
      </div>
    </div>

      {#if status.length }
      <span class="links" >
        {#each status as prStatus}
        <a href={ prStatus.target_url } title={ prStatus.key } >
            <Status state = { prStatus.state }/>
        </a>
        {/each}
      </span>
      {/if}

    {#if shownLinks.length}
      <div class="board-card-links embedded">
        {#each shownLinks as link}
          <CardLink item={link.target} type={ link.type } onSelect={ onSelect } />
        {/each}
      </div>
    {/if}

  </div>

  {#if prLinks.length}
    <div class="board-card-links attached">
      {#each prLinks as link}
        <CardLink item={ link.target } type={ link.type } onSelect={ onSelect } status={ link.status } />
      {/each}
  </div>
  {/if}

</div>
