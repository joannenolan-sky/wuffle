<script>
  import PullRequestIcon from './components/PullRequestIcon.svelte';
  import LinkIcon from './components/LinkIcon.svelte';
  import Status from './components/Status.svelte';

  import {
    hasModifier,
    hasShiftModifier
  } from './util';

  export let item;
  export let status;

  export let className = '';

  export let onSelect;

  export let type;

  $: id = item.id;
  $: number = item.number;
  $: title = item.title;
  $: repository = item.repository;
  $: pull_request = item.pull_request;
  $: state = item.state;

  $: status = status || [];

  $: assignees = item.assignees || [];

  $: requested_reviewers = item.requested_reviewers || [];

  $: repositoryName = `${repository.owner.login}/${repository.name}`;

  $: cardUrl = `https://github.com/${ repositoryName }/issues/${ number }`;

  $: linkTitle = ({
    CHILD_OF: 'Part of',
    DEPENDS_ON: 'Depends on',
    PARENT_OF: 'Depends on',
    CLOSED_BY: 'Closed by',
    REQUIRED_BY: 'Required by',
    CLOSES: 'Closes',
    LINKED_TO: 'Related to',
    LINKED_BY: 'Related to'
  })[type] || type;

  function handleSelection(qualifier, value, clickThrough=true) {

    return function(event) {

      if (clickThrough && !hasModifier(event)) {
        return;
      }

      event.preventDefault();

      onSelect(qualifier, value, hasShiftModifier(event));
    };
  }
</script>

<style lang="scss">
  @import "./Card";

  .card-link {
    border-top: solid 1px #F0F0F0;
    margin-top: 1px;
    padding-top: 1px;
  }

  .card-link .short-title {
    flex: 1;
  }

  .card-link .assignee {
    height: 16px;
  }

  :global(.card-link) .epic {
    color: #1d76db;
  }
</style>

<div class="card-link">
  <div class="header">
      {#if pull_request}
        <PullRequestIcon item={ item } onClick={ onSelect && handleSelection('ref', item.key, false) } />
      {:else}
        {#if type === 'PARENT_OF'}
          <LinkIcon name="issue" state={ state } onClick={ onSelect && handleSelection('ref', item.key, false) } />
        {/if}

        {#if type === 'CHILD_OF'}
          <LinkIcon name="epic" onClick={ onSelect && handleSelection('ref', item.key, false) } />
        {/if}

        {#if type === 'DEPENDS_ON' || type === 'CLOSED_BY'}
          <LinkIcon name="depends-on" state={ state } onClick={ onSelect && handleSelection('ref', item.key, false) } />
        {/if}

        {#if type === 'REQUIRED_BY' || type === 'CLOSES' }
          {#if state === 'open'}
            <LinkIcon name="linked-to" onClick={ onSelect && handleSelection('ref', item.key, false) } />
          {:else}
            <LinkIcon name="issue" state={ state } onClick={ onSelect && handleSelection('ref', item.key, false) } />
          {/if}
        {/if}

        {#if type === 'LINKED_TO'}
          <LinkIcon name="linked-to" onClick={ onSelect && handleSelection('ref', item.key, false) } />
        {/if}
      {/if}

    <a href={ cardUrl }
       target="_blank"
       rel="noopener noreferrer"
       class="issue-number"
       title="{ linkTitle } { repositoryName }#{ number }"
     >
      { number }
    </a>

    <span class="short-title" title={ title }>{ title }</span>

    <span class="collaborator-links">
      {#each assignees as assignee}
        <span class="assignee" title="{ assignee.login } assigned">
          <img src="{ assignee.avatar_url }&s=40" alt="{ assignee.login } avatar" />
        </span>
      {/each}

      {#each requested_reviewers as reviewer}
        <span class="assignee reviewer" title="{ reviewer.login } requested for review">
          <img src="{ reviewer.avatar_url }&s=40" alt="{ reviewer.login } avatar" />
        </span>
      {/each}
    </span>
  </div>
  {#if status.length }
  <div class="status">
    <span>
    {#each status as prStatus}
        <a href={ prStatus.target_url } title={ prStatus.key } >
            <Status state = {prStatus.state} length={ status.length}/>
        </a>
    {/each}
    </span>
  </div>
        {/if}
</div>